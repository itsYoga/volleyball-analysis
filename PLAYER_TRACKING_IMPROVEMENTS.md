# 玩家追蹤改進方案

## 問題分析

當前系統在追蹤玩家時產生了過多的 ID 碎片化問題：
- **問題**：前1000幀就產生了335個不同的追蹤ID，遠超過場上實際的30個玩家
- **原因**：
  1. Norfair 追蹤器參數設置不當，導致同一玩家在不同幀被分配不同ID
  2. 沒有穩定的玩家身份識別機制（如球衣號碼）
  3. 追蹤中斷後重新初始化導致ID碎片化

## 已實現的改進

### 1. **優化 Norfair 追蹤參數**
```python
self.tracker = norfair.Tracker(
    distance_function="euclidean",
    distance_threshold=100,  # 從50增加到100，允許更大的移動範圍
    initialization_delay=3,   # 從1增加到3，減少短暫誤檢測
    hit_counter_max=15        # 從10增加到15，需要更多連續檢測才認為追蹤穩定
)
```

### 2. **球衣號碼 OCR 識別**
- 使用 EasyOCR 自動識別球衣號碼
- 每10幀執行一次OCR（避免性能問題）
- 提取上半身區域進行識別（球衣號碼通常在胸部）
- 自動將球衣號碼映射到穩定ID

### 3. **穩定ID系統**
- `stable_id`：基於球衣號碼的穩定ID（1-99）
- `id`：Norfair追蹤ID（保留用於內部追蹤）
- `jersey_number`：識別到的球衣號碼

## 使用方式

### 安裝依賴
```bash
pip install easyocr
```

### 功能說明

1. **自動OCR識別**：
   - 系統會自動嘗試識別球衣號碼
   - 識別成功後，該追蹤ID會自動映射到球衣號碼
   - 之後同一球衣號碼會使用相同的穩定ID

2. **手動標記**（待實現）：
   ```python
   analyzer.set_jersey_number_mapping(track_id=123, jersey_number=7)
   ```

## 數據結構變化

### 追蹤結果格式
```python
{
    'id': 123,              # Norfair追蹤ID（可能變化）
    'stable_id': 7,        # 穩定ID（球衣號碼，如果識別成功）
    'bbox': [x1, y1, x2, y2],
    'confidence': 0.85,
    'jersey_number': 7     # 識別到的球衣號碼（如果成功）
}
```

## 進一步改進建議

### 1. **前端手動標記界面**
- 在視頻播放器中顯示無法識別的玩家
- 允許用戶點擊玩家並輸入球衣號碼
- 保存映射關係，應用到後續分析

### 2. **球衣號碼識別優化**
- 使用專門的球衣號碼識別模型（如 YOLO 訓練的數字檢測）
- 圖像預處理（對比度增強、二值化）
- 多幀融合（同一玩家多次識別結果投票）

### 3. **追蹤穩定性改進**
- 實現跨幀的球衣號碼一致性檢查
- 當檢測到同一球衣號碼出現在不同追蹤ID時，合併追蹤
- 使用卡爾曼濾波器預測玩家位置

### 4. **統計和可視化**
- 統計每個穩定ID（球衣號碼）的出現頻率
- 顯示識別成功率
- 標記需要手動標記的玩家

## 預期效果

實施這些改進後：
- ✅ 追蹤ID數量從數百個減少到30個左右（場上實際玩家數）
- ✅ 每個玩家有唯一的穩定ID（球衣號碼）
- ✅ 統計數據更準確（基於穩定ID）
- ✅ 用戶可以手動標記無法自動識別的玩家

## 測試建議

1. **重新分析視頻**，觀察穩定ID數量是否減少
2. **檢查識別率**，查看有多少球衣號碼被成功識別
3. **手動標記測試**，驗證手動映射功能是否正常
4. **統計驗證**，確保玩家統計數據正確

